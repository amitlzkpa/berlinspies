<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Berlin Spies</title>
  <meta name=viewport content=initial-scale=1,maximum-scale=1,user-scalable=no />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css" rel=stylesheet />
  <style>
    body {
      margin:0;
      padding:0;
      font-family: sans-serif;
      font-size: 14px;
    }

    #map { position:absolute; width:100%; height:700px; }
    #go { position:absolute; top:20px; right:20px; width:300px; background-color: white; height: 20px; text-align: center; }

    .currPMarker {
      background-color: red;
      border: 2px solid black;
      border-radius: 8px;
      width: 16px;
      height: 16px;
      /*cursor: pointer;*/
    }

    .choiceMarkers {
      background-color: yellow;
      border: 2px solid black;
      border-radius: 9px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }


    #panel {
      background: white;
      width: 400px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      position: absolute;
      right: 16px;
      top: 16px;
      box-shadow: 0 0 4px 0 rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.5);
    }
    h4 {
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      margin: 0;
      padding: 16px;
    }
    ul {
      list-style-type: none;
      margin: 0;
      padding: 16px;
    }
    ul span {
      width: 10px;
      height: 10px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 50%;
    }
    dd {
      margin-left: 0;
      margin-bottom: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>


<div class="container">
  <div class="row">
    <div class="col">
      <br/>
      <div class="jumbotron" style="background-color: white;">
        <span>Time:</span>
        <span id="currTime"></span>
        &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
        <span>Curr Player:</span>
        <span id="currPName"></span>
        &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
        <span>Cash:</span>
        <span id="currPCash"></span>
        &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
        <span>Result:</span>
        <span id="result"></span>
        <br/>
        <a href="#!" id="playBtn" class="btn btn-primary float-right">Move</a>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col">
    <div id="map"></div>
  </div>
</div>




<script>




 /**
         _   _ _     
   _   _| |_(_) |___ 
  | | | | __| | / __|
  | |_| | |_| | \__ \
   \__,_|\__|_|_|___/
                     
 
 **/




Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}

Date.prototype.addHours = function(hours) {
    var date = new Date(this.valueOf());
    date.setHours(date.getHours() + hours);
    return date;
}



function getDistance(ptA, ptB) {
  return Math.sqrt((Math.pow(ptB[0], 2) - Math.pow(ptA[0], 2)) + (Math.pow(ptB[1], 2) - Math.pow(ptA[1], 2)));
}

function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}

function pad(n){return n<10 ? '0'+n : n}




 /**
                     
                     
    __ _ _ __  _ __  
   / _` | '_ \| '_ \ 
  | (_| | |_) | |_) |
   \__,_| .__/| .__/ 
        |_|   |_|    
 
 
 **/




  mapboxgl.accessToken = 'pk.eyJ1IjoiYW1pdGx6a3BhIiwiYSI6ImNpZmN6ZW12ZzRvYTFzeG03ZDdkNzd5d2oifQ.FxgL_waU-ZRhhtQdeOvtcA';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/amitlzkpa/cjpeiq18h09vb2rnakpt4twwh',
    center: [9.68, 50.8],
    zoom: 5.3,
    minZoom: 0,
    maxZoom: 18,
    // hash: true
  });

  let nav = new mapboxgl.NavigationControl();
  map.addControl(nav, 'top-left');










  function Player(name, startLoc, type, startCash, data) {
    this.name = name;
    this.location = startLoc;
    this.type = type || 'cop';
    this.cash = startCash || 100;
    this.data = data || {};
  }



  let players = [
                  new Player("The Spy from Lesotho ðŸ•µï¸", [13.492286, 52.636162], 'spy', 100000),
                  new Player("Allied Agent",  [7.537458, 51.518768], 'cop', 300),
                  new Player("Axis Agent",  [7.007252,51.48437], 'cop', 300)
                ]
  
                
  let currPIdx = 0;
  let currPMrkr = null;
  let currTime = new Date(1979, 1, 1, 0, 0, 0, 0)
  let turnIdx = 0;
  
  let currChoices = [];



  let el = document.createElement('div');
  el.className = 'currPMarker';
  currPMrkr = new mapboxgl.Marker(el)
                          .setLngLat(players[currPIdx].location)
                          .addTo(map);
  $("#currPName").text(players[currPIdx].name);
  $("#currPCash").text(players[currPIdx].cash);
  $("#currTime").text(`${currTime.toDateString()} ${currTime.getHours()}:00`);



  async function render() {

    console.log(turnIdx);
    
    // clear board
    currPMrkr.remove();
    currChoices.forEach(m => m.remove());
    currChoices = [];

    // update board with current players details
    $("#currPName").text(players[currPIdx].name);
    $("#currPCash").text(players[currPIdx].cash);

    let el = document.createElement('div');
    el.className = 'currPMarker';
    currPMrkr = new mapboxgl.Marker(el)
                            .setLngLat(players[currPIdx].location)
                            .addTo(map);

    let playerPopup = `<h4>${players[currPIdx].name}</h4><br /><p>Cash: ${players[currPIdx].cash}</p>`;
    new mapboxgl.Marker(el)
      .setLngLat(players[currPIdx].location)
      .setPopup(new mapboxgl.Popup({ offset: 25 })
        .setHTML(playerPopup))
      .addTo(map);


    let isSpy = (players[currPIdx].type === 'spy');
    

    let imgURL = isSpy ? '/icons/noun_Ninja_23386.png' : '/icons/noun_Scared Police_1258357.png';


    // get list of departures available to current player
    let departures = (await $.get(`/fahr/DepartureBoard`)).Departure;
    let lim = [3, 8, 12][(Math.floor(Math.random() * 3))]; // number of trains out


    // if spy
      // show name and cash
      // show all cops
      // show spy

    // if cop
      // show name and cash
      // show all cops
      // show spy if 15th turn


    // update board with available options
    for(let i=0; i<lim; i++) {
      let dep = departures[i];
      let dstName = dep.stop;
      dstName = dstName.replace('(', ' (').replace(')', ') ');
      while(dstName.indexOf('  ') != -1)
        dstName = dstName.replace('  ', ' ');
      let dstStnData = (await $.get(`/stn/stations?name=${dstName}`))[0];
      
      let loc = dstStnData.evaNumbers[0].geographicCoordinates;
      

      let chMarkerEl = document.createElement('div');
      chMarkerEl.className = 'choiceMarkers';
      let chMrkr = new mapboxgl.Marker(chMarkerEl)
                              .setLngLat(loc.coordinates)
                              .addTo(map);

      let choicePopup = `<h4>${dstName}</h4><br /><p>Price: ${dstStnData.priceCategory * 100}</p>`;
      new mapboxgl.Marker(chMarkerEl)
        .setLngLat(loc.coordinates)
        .setPopup(new mapboxgl.Popup({ offset: 25 })
          .setHTML(choicePopup))
        .addTo(map);

    }

    

    // check if caught
    // update with results

    if((getDistance(players[0].location, players[1].location) < 0.02)
    || (getDistance(players[0].location, players[2].location) < 0.02)) {
      $("#result").text('Game Over!!');
    }

    currTime = currTime.addDays(1);
    currTime = currTime.addHours(1);
    currPIdx++;
    currPIdx %= players.length;
    $("#currTime").text(`${currTime.toDateString()} ${currTime.getHours()}:00`);
    turnIdx++;

  }


  render();



  $("#playBtn").on('click', async function(event) {
    render();
  })





  map.on('click', async function(event) {

    let geometry = event.point;
    let parameters = {
      // layers: ['railwaynodes', 'railwaystationnodes', 'railwaylines']
      // layers: ['railwaystationnodes']
      layers: ['jumpLayer']
    }

    var mapLayer = map.getLayer('jumpLayer');
    if(typeof mapLayer === 'undefined') return;

    let features = map.queryRenderedFeatures(geometry, parameters);

    if(features.length < 1) return;

    let pos = JSON.parse(features[0].properties.data).location;
    players[currPIdx].location = pos;
    render();
    // let name = features[0].properties.geographicalName;
    // let srcStnData = (await $.get(`http://127.0.0.1:4000/stations?name=${name}`))[0];
    // let srcId = srcStnData.evaNumbers[0].number;

  });





</script>





</body>
</html>