<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Berlin Spies</title>
  <meta name=viewport content=initial-scale=1,maximum-scale=1,user-scalable=no />

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css" rel=stylesheet />
  <style>

    body {
      margin:0;
      padding:0;
    }

    #map { position:absolute; width:100%; height:700px; }

    .currPMarker {
      background-color: red;
      border: 2px solid black;
      border-radius: 12px;
      width: 24px;
      height: 24px;
    }

    .choiceMarkers {
      background-color: yellow;
      border: 2px solid black;
      border-radius: 6px;
      width: 12px;
      height: 12px;
      cursor: pointer;
    }

    .copMarker{
      background-color: lightblue;
      border: 2px solid white;
      border-radius: 8px;
      width: 16px;
      height: 16px;
    }

    .spyMarker{
      background-color: darkgray;
      border: 2px solid black;
      border-radius: 10px;
      width: 20px;
      height: 20px;
    }
    /* // let imgURL = isSpy ? '/icons/noun_Ninja_23386.png' : '/icons/noun_Scared Police_1258357.png'; */
    
  </style>
</head>
<body>


<div class="container">
  <hr />
  <div class="row">

    <div class="col">
      <table class="table">
        <tr>
          <td><span>Time:</span></td>
          <td><span id="currTime"></span></td>
        </tr>
        <tr>
          <td><span>Curr Player:</span></td>
          <td><span id="currPName"></span></td>
        </tr>
        <tr>
          <td><span>Cash:</span></td>
          <td><span id="currPCash"></span></td>
        </tr>
      </table>
    </div>

    <div class="col">
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-subtitle text-muted">Message:</h6>
          <p id="result"></p>
        </div>
      </div>
      <button id="skipBtn" class="btn btn-secondary">Skip</button>
    </div>
    
  </div>
</div>

<div class="row">
  <div class="col">
    <div id="map"></div>
  </div>
</div>




<script>




 /**
         _   _ _     
   _   _| |_(_) |___ 
  | | | | __| | / __|
  | |_| | |_| | \__ \
   \__,_|\__|_|_|___/
                     
 
 **/




Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}

Date.prototype.addHours = function(hours) {
    var date = new Date(this.valueOf());
    date.setHours(date.getHours() + hours);
    return date;
}



function getDistance(ptA, ptB) {
  return Math.sqrt((Math.pow(ptB[0], 2) - Math.pow(ptA[0], 2)) + (Math.pow(ptB[1], 2) - Math.pow(ptA[1], 2)));
}

function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}

function pad(n){return n<10 ? '0'+n : n}

function sleep(milliseconds) {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}



 /**
                     
                     
    __ _ _ __  _ __  
   / _` | '_ \| '_ \ 
  | (_| | |_) | |_) |
   \__,_| .__/| .__/ 
        |_|   |_|    
 
 
 **/




  mapboxgl.accessToken = 'pk.eyJ1IjoiYW1pdGx6a3BhIiwiYSI6ImNpZmN6ZW12ZzRvYTFzeG03ZDdkNzd5d2oifQ.FxgL_waU-ZRhhtQdeOvtcA';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/amitlzkpa/cjpeiq18h09vb2rnakpt4twwh',
    center: [9.68, 50.8],
    zoom: 5.3,
    minZoom: 0,
    maxZoom: 18,
    // hash: true
  });

  let nav = new mapboxgl.NavigationControl();
  map.addControl(nav, 'top-left');










  function Player(name, startLoc, type, startCash, data) {
    this.name = name;
    this.location = startLoc;
    this.type = type || 'cop';
    this.cash = startCash || 100;
    this.data = data || {};
  }



  let players = [
                  new Player("The Spy from Lesotho 🕵️", [13.492286, 52.636162], 'spy', 10000),
                  new Player("Allied Agent",  [7.537458, 51.518768], 'cop', 1000),
                  new Player("Axis Agent",  [7.007252,51.48437], 'cop', 1000)
                ];
  
                
  let currPIdx = 0;
  let currTime = new Date(1970, 0, 0, 0, 0, 0, 0)
  let turnIdx = 0;
  
  let currChoices = [];
  let currPMrkr = null;
  let choicePopups = [];

  let copMrkrs = [];
  let spyMrkrs = [];


      
  async function jumpHere(pos) {
    players[currPIdx].location = pos;
    await moveCounters();
    await render();
  }


  $("#skipBtn").on('click', async function(event) {
    await moveCounters();
    await render();
  })


  function moveCounters() {
    currTime = currTime.addDays(1);
    currTime = currTime.addHours(1);
    currPIdx++;
    currPIdx %= players.length;
    turnIdx++;
  }


  async function clear() {
    if(currPMrkr) currPMrkr.remove();
    currChoices.forEach(m => m.remove());
    currChoices = [];
    choicePopups.forEach(m => m.remove());
    choicePopups = [];
    copMrkrs.forEach(m => m.remove());
    copMrkrs = [];
    spyMrkrs.forEach(m => m.remove());
    spyMrkrs = [];
  }


  async function render() {

    // clear board
    await clear();
    
    console.log(turnIdx);
    console.log(players[currPIdx]);

    // update board with current players details
    let currPMkEl = document.createElement('div');
    currPMkEl.className = 'currPMarker';
    currPMrkr = new mapboxgl.Marker(currPMkEl)
                            .setLngLat(players[currPIdx].location)
                            .addTo(map);
    $("#currPName").text(players[currPIdx].name);
    $("#currPCash").text(players[currPIdx].cash);
    $("#currTime").text(`${currTime.toDateString()} ${currTime.getHours()}:00`);


    let playerPopup = `<h4>${players[currPIdx].name}</h4>
                       <br />
                       <p>Cash: ${players[currPIdx].cash}</p>`;
    new mapboxgl.Marker(currPMkEl)
      .setLngLat(players[currPIdx].location)
      .setPopup(new mapboxgl.Popup({ offset: 25 })
      .setHTML(playerPopup))
      .addTo(map);


    let isSpy = (players[currPIdx].type === 'spy');

    // show all cops
    let copPlayers = players.filter(p => p.type === 'cop');
    for(let i=0; i<copPlayers.length; i++) {
      let p = copPlayers[i];
      let copMkEl = document.createElement('div');
      copMkEl.className = 'copMarker';
      let copMrkr = new mapboxgl.Marker(copMkEl)
                              .setLngLat(p.location)
                              .addTo(map);
      copMrkrs.push(copMrkr);
    }

    // if spy or 15th turn show spy
    if (isSpy || (turnIdx % 15 === 0)) {
      
      let spyPlayers = players.filter(p => p.type === 'spy');
      for(let i=0; i<spyPlayers.length; i++) {
        let p = spyPlayers[i];
        let spyMkEl = document.createElement('div');
        spyMkEl.className = 'spyMarker';
        let spyMrkr = new mapboxgl.Marker(spyMkEl)
                                .setLngLat(p.location)
                                .addTo(map);
        spyMrkrs.push(spyMrkr);
      }

    }


    // get list of departures available to current player
    let departures = (await $.get(`/fahr/DepartureBoard`)).Departure;
    let lim = [3, 8, 12][(Math.floor(Math.random() * 3))]; // number of trains out


    // update board with available options
    for(let i=0; i<lim; i++) {
      let dep = departures[i];
      // console.log(dep);
      let dstName = dep.stop;
      dstName = dstName.replace('(', ' (').replace(')', ') ');
      while(dstName.indexOf('  ') != -1)
        dstName = dstName.replace('  ', ' ');
      let dstStnData = (await $.get(`/stn/stations?name=${dstName}`))[0];
      
      let loc = dstStnData.evaNumbers[0].geographicCoordinates;

      let chMarkerEl = document.createElement('div');
      chMarkerEl.className = 'choiceMarkers';
      let chMrkr = new mapboxgl.Marker(chMarkerEl)
                              .setLngLat(loc.coordinates)
                              .addTo(map);

      let choicePopupHtml = `<h4>${dstName}</h4>
                        <br />
                        <p>Price: ${dstStnData.priceCategory * 100}</p>
                        <br />
                        <button class="btn btn-primary"
                                onclick="jumpHere([${loc.coordinates[0]}, ${loc.coordinates[1]}])">Move Here</button>`;
      let choicePopup = new mapboxgl.Popup({ offset: 25 })
                        .setHTML(choicePopupHtml);
      choicePopups.push(choicePopup);
      
      new mapboxgl.Marker(chMarkerEl)
        .setLngLat(loc.coordinates)
        .setPopup(choicePopup)
        .addTo(map);
      
    }

    

    // check if caught
    // update with results
    if((getDistance(players[0].location, players[1].location) < 0.02)
    || (getDistance(players[0].location, players[2].location) < 0.02)) {
      $("#result").text('Game Over!!');
    }

  }


  render();


</script>





</body>
</html>