<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Berlin Spies</title>
  <meta name=viewport content=initial-scale=1,maximum-scale=1,user-scalable=no />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css" rel=stylesheet />
  <style>
    body {
      margin:0;
      padding:0;
      font-family: sans-serif;
      font-size: 14px;
    }

    #map { position:absolute; width:100%; height:700px; }
    #go { position:absolute; top:20px; right:20px; width:300px; background-color: white; height: 20px; text-align: center; }

    .currPMarker {
      background-color: red;
      border: 1px solid black;
      width: 16px;
      height: 16px;
      /*cursor: pointer;*/
    }

    .choiceMarkers {
      background-color: yellow;
      border: 1px solid black;
      width: 12px;
      height: 12px;
      cursor: pointer;
    }


    #panel {
      background: white;
      width: 400px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      position: absolute;
      right: 16px;
      top: 16px;
      box-shadow: 0 0 4px 0 rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.5);
    }
    h4 {
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      margin: 0;
      padding: 16px;
    }
    ul {
      list-style-type: none;
      margin: 0;
      padding: 16px;
    }
    ul span {
      width: 10px;
      height: 10px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 50%;
    }
    dd {
      margin-left: 0;
      margin-bottom: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>


<div class="container">
  <div class="row">
    <div class="col">
      <br/>
      <div class="jumbotron" style="background-color: white;">
        <span>Time:</span>
        <span id="currTime"></span>
        &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
        <span>Curr Player:</span>
        <span id="currPName"></span>
        &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
        <span>Result:</span>
        <span id="result"></span>
        <br/>
        <a href="#!" id="playBtn" class="btn btn-primary float-right">Move</a>
      </div>
      <div>
        Icon credits:
        <ul>
          <li>Ninja by I Create Stuff from the Noun Project</li>
          <li>Scared Police by Gan Khoon Lay from the Noun Project</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col">
    <div id="map"></div>
  </div>
</div>




<script>



Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}

Date.prototype.addHours = function(hours) {
    var date = new Date(this.valueOf());
    date.setHours(date.getHours() + hours);
    return date;
}



function getDistance(ptA, ptB) {
  return Math.sqrt((Math.pow(ptB[0], 2) - Math.pow(ptA[0], 2)) + (Math.pow(ptB[1], 2) - Math.pow(ptA[1], 2)));
}

function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}

function pad(n){return n<10 ? '0'+n : n}








  mapboxgl.accessToken = 'pk.eyJ1IjoiYW1pdGx6a3BhIiwiYSI6ImNpZmN6ZW12ZzRvYTFzeG03ZDdkNzd5d2oifQ.FxgL_waU-ZRhhtQdeOvtcA';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/amitlzkpa/cjpeiq18h09vb2rnakpt4twwh',
    center: [9.68, 50.8],
    zoom: 5.3,
    minZoom: 0,
    maxZoom: 18,
    // hash: true
  });

  let nav = new mapboxgl.NavigationControl();
  map.addControl(nav, 'top-left');










  function Player(n, l, c) {
    this.name = n;
    this.location = l;
    this.cash = c;
  }



  let players = [
                  new Player("The Spy from Lesotho 🕵️",   [13.492286, 52.636162],   100000),
                  new Player("Allied Agent",  [7.537458, 51.518768],    300),
                  new Player("Axis Agent",  [7.007252,51.48437],      300)
                ]
  let currPIdx = 0;
  let currPMrkr = null;
  let currTime = new Date(2018, 7, 1, 15, 0, 0, 0)
  let currChoices = [];



  let el = document.createElement('div');
  el.className = 'currPMarker';
  currPMrkr = new mapboxgl.Marker(el)
                          .setLngLat(players[currPIdx].location)
                          .addTo(map);
  $("#currPName").text(players[currPIdx].name);
  $("#currTime").text(`${currTime.toDateString()} ${currTime.getHours()}:00`);



  async function render() {

    currPMrkr.remove();
    let el = document.createElement('div');
    el.className = 'currPMarker';
    currPMrkr = new mapboxgl.Marker(el)
                            .setLngLat(players[currPIdx].location)
                            .addTo(map);

    currChoices.forEach(m => m.remove());
    currChoices = [];
    let departures = (await $.get(`/fahr/DepartureBoard`)).Departure;
    let lim = [3, 8, 12][(Math.floor(Math.random() * 3))];

    let addObj = 
    {
        "id": "jumpLayer",
        "type": "symbol",
        "source": {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": []
            }
        }
    }

    for(let i=0; i<lim; i++) {
      let dep = departures[i];
      let dstName = dep.stop;
      dstName = dstName.replace('(', ' (').replace(')', ') ');
      while(dstName.indexOf('  ') != -1)
        dstName = dstName.replace('  ', ' ');
      let dstStnData = (await $.get(`/stn/stations?name=${dstName}`))[0];
      
      let loc = dstStnData.evaNumbers[0].geographicCoordinates;

      let addM = 
          {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": loc.coordinates
            },
            "properties": {
                "data": {
                  "location": loc.coordinates
                },
            }
          };
      addObj.source.data.features.push(addM);
    }
    if(typeof map.getLayer('jumpLayer') !== 'undefined')
      map.removeLayer('jumpLayer').removeSource('jumpLayer');
    let onSpy = (players[currPIdx].name.toLowerCase().indexOf('agent') < 0);
    let imgURL = onSpy ? '/icons/noun_Ninja_23386.png' : '/icons/noun_Scared Police_1258357.png';
    map.loadImage(imgURL, function(error, image) {
      if(error) {
        console.log(error);
        return;
      }
      let imgLbl = onSpy ? 'spyJumpLoc' : 'copJumpLoc';
      map.addImage(imgLbl, image);
      addObj["layout"] = {
        "icon-image": imgLbl,
        "icon-size": 0.15,
        "text-field": "{data.name}",
        "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
        "text-offset": [0, 0.6],
        "text-anchor": "top"
      }
      map.addLayer(addObj);

      if((getDistance(players[0].location, players[1].location) < 0.02)
      || (getDistance(players[0].location, players[2].location) < 0.02)) {
        $("#result").text('Game Over!!');
      }

      currTime = currTime.addDays(1);
      currTime = currTime.addHours(1);
      currPIdx++;
      currPIdx %= players.length;
      $("#currPName").text(players[currPIdx].name);
      $("#currTime").text(`${currTime.toDateString()} ${currTime.getHours()}:00`);

    });

  }


  // render();



  $("#playBtn").on('click', async function(event) {
    render();
  })





  map.on('click', async function(event) {

    let geometry = event.point;
    let parameters = {
      // layers: ['railwaynodes', 'railwaystationnodes', 'railwaylines']
      // layers: ['railwaystationnodes']
      layers: ['jumpLayer']
    }

    var mapLayer = map.getLayer('jumpLayer');
    if(typeof mapLayer === 'undefined') return;

    let features = map.queryRenderedFeatures(geometry, parameters);

    if(features.length < 1) return;

    let pos = JSON.parse(features[0].properties.data).location;
    players[currPIdx].location = pos;
    render();
    // let name = features[0].properties.geographicalName;
    // let srcStnData = (await $.get(`http://127.0.0.1:4000/stations?name=${name}`))[0];
    // let srcId = srcStnData.evaNumbers[0].number;

  });





</script>





</body>
</html>